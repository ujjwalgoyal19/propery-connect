---
title: 'Database & Prisma ORM'
description: 'Database schema, Prisma ORM usage, and migration guide'
icon: 'database'
---

## Database Overview

Propery Connect uses **PostgreSQL 15 via Supabase** with **Prisma ORM** for type-safe database access. Row-Level Security (RLS) policies are implemented for data access control.

## Prisma ORM Integration

### What is Prisma?

Prisma is a next-generation Node.js and TypeScript ORM that provides:

- **Type Safety** - Auto-generated types from schema
- **Query Builder** - Type-safe database queries
- **Migrations** - Version-controlled schema changes
- **Studio** - GUI for database management
- **Performance** - Connection pooling and query optimization

### Prisma Client

The Prisma Client is initialized as a singleton in `apps/api/src/lib/prisma.ts`:

```typescript
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export default prisma;
```

### Using Prisma in Services

Type-safe database operations:

```typescript
import prisma from '@/lib/prisma';

// Create
const user = await prisma.user.create({
  data: { email, phone, name },
});

// Read
const listing = await prisma.listing.findUnique({
  where: { id },
  include: { user: true },
});

// Update
await prisma.listing.update({
  where: { id },
  data: { status: 'sold' },
});

// Delete
await prisma.message.delete({
  where: { id },
});

// List with pagination
const listings = await prisma.listing.findMany({
  where: { status: 'active' },
  skip: (page - 1) * limit,
  take: limit,
  orderBy: { createdAt: 'desc' },
});
```

## Database Schema

### Prisma Schema

The complete schema is defined in `apps/api/prisma/schema.prisma`:

### users

User profiles and authentication data.

| Column     | Type         | Constraints                             |
| ---------- | ------------ | --------------------------------------- |
| id         | UUID         | PRIMARY KEY, default: gen_random_uuid() |
| phone      | VARCHAR(20)  | UNIQUE, NOT NULL                        |
| email      | VARCHAR(255) |                                         |
| created_at | TIMESTAMP    | default: CURRENT_TIMESTAMP              |

### listings

Property listings posted by users.

| Column        | Type         | Constraints                 |
| ------------- | ------------ | --------------------------- |
| id            | UUID         | PRIMARY KEY                 |
| user_id       | UUID         | FOREIGN KEY → users(id)     |
| title         | VARCHAR(200) | NOT NULL                    |
| description   | TEXT         |                             |
| price         | NUMERIC      | NOT NULL, CHECK (price > 0) |
| location      | VARCHAR(200) | NOT NULL                    |
| category      | VARCHAR(50)  | NOT NULL                    |
| images        | TEXT[]       | default: '{}'               |
| contact_phone | VARCHAR(20)  |                             |
| contact_email | VARCHAR(255) |                             |
| amenities     | TEXT[]       |                             |
| status        | VARCHAR(50)  | default: 'active'           |
| created_at    | TIMESTAMP    | default: CURRENT_TIMESTAMP  |
| updated_at    | TIMESTAMP    | default: CURRENT_TIMESTAMP  |

**Categories**: `apartment`, `house`, `commercial`, `land`, `other`
**Status**: `active`, `inactive`, `sold`

### tokens

Authentication tokens for user sessions.

| Column     | Type      | Constraints                |
| ---------- | --------- | -------------------------- |
| id         | UUID      | PRIMARY KEY                |
| token      | UUID      | UNIQUE, NOT NULL           |
| user_id    | UUID      | FOREIGN KEY → users(id)    |
| listing_id | UUID      | FOREIGN KEY → listings(id) |
| expires_at | TIMESTAMP | NOT NULL                   |
| created_at | TIMESTAMP | default: CURRENT_TIMESTAMP |

### payments

Payment records from Razorpay integration.

| Column     | Type         | Constraints                  |
| ---------- | ------------ | ---------------------------- |
| id         | UUID         | PRIMARY KEY                  |
| listing_id | UUID         | FOREIGN KEY → listings(id)   |
| user_id    | UUID         | FOREIGN KEY → users(id)      |
| order_id   | VARCHAR(100) | UNIQUE, NOT NULL             |
| payment_id | VARCHAR(100) |                              |
| amount     | NUMERIC      | NOT NULL, CHECK (amount > 0) |
| currency   | VARCHAR(3)   | default: 'INR'               |
| status     | VARCHAR(50)  | default: 'pending'           |
| created_at | TIMESTAMP    | default: CURRENT_TIMESTAMP   |
| updated_at | TIMESTAMP    | default: CURRENT_TIMESTAMP   |

### messages

WhatsApp message logs via Twilio.

| Column      | Type         | Constraints                |
| ----------- | ------------ | -------------------------- |
| id          | UUID         | PRIMARY KEY                |
| listing_id  | UUID         | FOREIGN KEY → listings(id) |
| sender      | VARCHAR(20)  | NOT NULL                   |
| recipient   | VARCHAR(20)  | NOT NULL                   |
| message     | TEXT         | NOT NULL                   |
| message_sid | VARCHAR(100) |                            |
| status      | VARCHAR(50)  | default: 'sent'            |
| sent_at     | TIMESTAMP    | default: CURRENT_TIMESTAMP |

## Row-Level Security Policies

### users Table

```sql
-- Anyone can view user profiles
CREATE POLICY "users_select" ON users
FOR SELECT USING (true);

-- Users can only update their own data
CREATE POLICY "users_update" ON users
FOR UPDATE USING (auth.uid() = id);
```

### listings Table

```sql
-- Listings are publicly readable
CREATE POLICY "listings_select" ON listings
FOR SELECT USING (true);

-- Users can create listings
CREATE POLICY "listings_insert" ON listings
FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Users can only update their own listings
CREATE POLICY "listings_update" ON listings
FOR UPDATE USING (auth.uid() = user_id);

-- Users can only delete their own listings
CREATE POLICY "listings_delete" ON listings
FOR DELETE USING (auth.uid() = user_id);
```

<Note>
  RLS policies enforce data access control at the database level, providing an additional security
  layer beyond application-level checks.
</Note>

## Indexes

Performance indexes on frequently queried columns:

```sql
CREATE INDEX idx_listings_user_id ON listings(user_id);
CREATE INDEX idx_listings_status ON listings(status);
CREATE INDEX idx_listings_category ON listings(category);
CREATE INDEX idx_listings_location ON listings(location);
CREATE INDEX idx_tokens_token ON tokens(token);
CREATE INDEX idx_tokens_expires_at ON tokens(expires_at);
CREATE INDEX idx_payments_order_id ON payments(order_id);
```

## Migrations

All schema changes should be made through migration files in `supabase/migrations/`.

### Creating a Migration

```bash
# Using Supabase CLI
npx supabase migration new add_verified_column_to_users

# Or create file manually
touch supabase/migrations/00002_add_verified_column.sql
```

### Running Migrations

<Tabs>
  <Tab title="Supabase CLI">
    ```bash
    # Push to linked project
    npx supabase db push

    # Pull from remote
    npx supabase db pull
    ```

  </Tab>

  <Tab title="Manual">
    1. Open Supabase SQL Editor
    2. Copy migration SQL
    3. Execute in production database
  </Tab>
</Tabs>

## Best Practices

<AccordionGroup>
  <Accordion icon="arrow-up" title="Always Use Migrations">
    Never modify schema directly in production. All changes go through migration files for version control.
  </Accordion>

<Accordion icon="shield" title="Define RLS Policies">
  Every table should have RLS enabled with appropriate policies for security.
</Accordion>

<Accordion icon="magnifying-glass" title="Add Indexes">
  Index foreign keys and frequently queried columns for better performance.
</Accordion>

  <Accordion icon="list-ol" title="Sequential Naming">
    Name migrations sequentially: `00001_`, `00002_`, etc. for predictable order.
  </Accordion>
</AccordionGroup>

## Next Steps

<CardGroup cols={2}>
  <Card title="Code Patterns" icon="code" href="/development/patterns">
    Learn how to query the database from code
  </Card>
  <Card title="Backend Services" icon="server" href="/backend/services">
    Explore database service layer implementations
  </Card>
</CardGroup>
